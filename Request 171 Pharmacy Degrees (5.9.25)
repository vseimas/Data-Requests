WITH CIPCTE AS (
select d.id, d.TERM_CODE_GRADUATION, d.DEGC_CODE, d.DEGS_DESC, d.MAJR_CODE1_DEGREE, d.MAJR_DESC1_DEGREE,
d.MAJR_CODE1_2_DEGREE, d.MAJR_DESC1_2_DEGREE,
LEFT(s1.STVMAJR_CIPC_CODE, 2) + '.' + RIGHT(s1.STVMAJR_CIPC_CODE, 4) As CIPCODE_DEG1,
LEFT(s2.STVMAJR_CIPC_CODE, 2) + '.' + RIGHT(s2.STVMAJR_CIPC_CODE, 4) As CIPCODE_DEG2,
 case
      when DEGS_CODE IN ('AW') AND TERM_CODE_GRADUATION BETWEEN '202434' AND '202533' then '2024-25'
      when DEGS_CODE IN ('AW') AND TERM_CODE_GRADUATION = '202551' then '2024-25'

      when DEGS_CODE IN ('AW') AND TERM_CODE_GRADUATION BETWEEN '202334' AND '202433' then '2023-24'
      when DEGS_CODE IN ('AW') AND TERM_CODE_GRADUATION = '202451' then '2023-24'

      when DEGS_CODE IN ('AW') AND TERM_CODE_GRADUATION BETWEEN '202234' AND '202333' then '2022-23'
      when DEGS_CODE IN ('AW') AND TERM_CODE_GRADUATION = '202351' then '2022-23'

      when DEGS_CODE IN ('AW') AND TERM_CODE_GRADUATION BETWEEN '202134' AND '202233' then '2021-22'
      when DEGS_CODE IN ('AW') AND TERM_CODE_GRADUATION = '202251' then '2021-22'

      when DEGS_CODE IN ('AW') AND TERM_CODE_GRADUATION BETWEEN '202034' AND '202133' then '2020-21'
      when DEGS_CODE IN ('AW') AND TERM_CODE_GRADUATION = '202151' then '2020-21'

      when DEGS_CODE IN ('AW') AND TERM_CODE_GRADUATION BETWEEN '201934' AND '202033' then '2019-20'
      when DEGS_CODE IN ('AW') AND TERM_CODE_GRADUATION = '202051' then '2019-20'

      when DEGS_CODE IN ('AW') AND TERM_CODE_GRADUATION BETWEEN '201834' AND '201933' then '2018-19'
      when DEGS_CODE IN ('AW') AND TERM_CODE_GRADUATION = '201951' then '2018-19'

      when DEGS_CODE IN ('AW') AND TERM_CODE_GRADUATION BETWEEN '201734' AND '201833' then '2017-18'
      when DEGS_CODE IN ('AW') AND TERM_CODE_GRADUATION = '201851' then '2017-18'

      when DEGS_CODE IN ('AW') AND TERM_CODE_GRADUATION BETWEEN '201634' AND '201733' then '2016-17'
      when DEGS_CODE IN ('AW') AND TERM_CODE_GRADUATION = '201751' then '2016-17'

      when DEGS_CODE IN ('AW') AND TERM_CODE_GRADUATION BETWEEN '201534' AND '201633' then '2015-16'
      when DEGS_CODE IN ('AW') AND TERM_CODE_GRADUATION = '201651' then '2015-16'

      when DEGS_CODE IN ('AW') AND TERM_CODE_GRADUATION BETWEEN '201434' AND '201533' then '2014-15'
      when DEGS_CODE IN ('AW') AND TERM_CODE_GRADUATION = '201551' then '2014-15'

      when DEGS_CODE IN ('AW') AND TERM_CODE_GRADUATION BETWEEN '201334' AND '201433' then '2013-14'
      when DEGS_CODE IN ('AW') AND TERM_CODE_GRADUATION = '201451' then '2013-14'

      when DEGS_CODE IN ('AW') AND TERM_CODE_GRADUATION BETWEEN '201234' AND '201333' then '2012-13'
      when DEGS_CODE IN ('AW') AND TERM_CODE_GRADUATION = '201351' then '2012-13'

      when DEGS_CODE IN ('AW') AND TERM_CODE_GRADUATION BETWEEN '201134' AND '201233' then '2011-12'
      when DEGS_CODE IN ('AW') AND TERM_CODE_GRADUATION = '201251' then '2011-12'

      when DEGS_CODE IN ('AW') AND TERM_CODE_GRADUATION BETWEEN '201034' AND '201133' then '2010-11'
      when DEGS_CODE IN ('AW') AND TERM_CODE_GRADUATION = '201151' then '2010-11'

      when DEGS_CODE IN ('AW') AND TERM_CODE_GRADUATION BETWEEN '200934' AND '201033' then '2009-10'
      when DEGS_CODE IN ('AW') AND TERM_CODE_GRADUATION = '201051' then '2009-10'

      when DEGS_CODE IN ('AW') AND TERM_CODE_GRADUATION BETWEEN '200834' AND '200933' then '2008-09'
      when DEGS_CODE IN ('AW') AND TERM_CODE_GRADUATION = '200951' then '2008-09' 
	  
	  when DEGS_CODE IN ('AW') AND TERM_CODE_GRADUATION BETWEEN '200734' AND '200833' then '2007-08'
      when DEGS_CODE IN ('AW') AND TERM_CODE_GRADUATION = '200851' then '2007-08'END As AcadYear

FROM DEGREES d 
left join
 STVMAJR s1 on d.MAJR_CODE1_DEGREE = s1.STVMAJR_CODE
left join
STVMAJR s2 on d.MAJR_CODE1_2_DEGREE = s2.STVMAJR_CODE
WHERE
 ---   DEGC_CODE LIKE 'B%' and
DEGS_CODE in ('AW' )
  AND COLL_CODE_DEGREE IN ('PH', 'SP'))

  select AcadYear, DEGC_CODE, count(id) as count
---  , CIPCODE_DEG1, MAJR_DESC1_DEGREE
  from CIPCTE 
  where AcadYear is not null
  and CIPCODE_DEG1 like '51.20%'
  group by AcadYear, DEGC_CODE
---  , CIPCODE_DEG1, MAJR_DESC1_DEGREE
  order by AcadYear, 
  case DEGC_CODE 
  when 'MS' then 1
  when 'PHD' then 2
  when 'PharmD' then 3 END
